<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VerseCurator Phase 3.5 ‚Äì Core Bible Experience (MVP with Auth)</title>

  <!-- PWA Manifest & Icons (from dev17) -->
  <link rel="manifest" href="https://mashifmj-prog.github.io/VerseCurator-dev17/manifest.json" />
  <link rel="icon" href="https://mashifmj-prog.github.io/VerseCurator-dev17/favicon.ico" />
  <meta name="theme-color" content="#1a1a2e" />

  <!-- Firebase SDK (v10+ Modular, as of 2025) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    window.firebaseAuth = { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged };
  </script>

  <!-- Core Styles: Modern UI + Dark Mode (dev17 foundation) -->
  <link rel="stylesheet" href="https://mashifmj-prog.github.io/VerseCurator-dev17/css/style.css" />
  <style>
    /* Inline enhancements to bridge gaps */
    :root {
      --primary: #4a90e2;
      --bg-light: #f8f9fa;
      --bg-dark: #16213e;
      --text-light: #333;
      --text-dark: #e0e0e0;
    }
    body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-dark); }
    .app { max-width: 1200px; margin: auto; padding: 1rem; }
    .nav { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 1rem; position: sticky; top:0; z-index:100; }
    .nav a { color: white; text-decoration: none; font-weight: 600; }
    .reader { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; margin-top: 1rem; }
    .verse-text { line-height: 1.8; font-size: 1.1rem; }
    .verse { margin-bottom: 0.5rem; }
    .verse-num { font-weight: bold; color: var(--primary); margin-right: 0.3rem; }
    .highlight { background: rgba(255,215,0,0.3); padding: 0 4px; border-radius: 3px; }
    .notes-panel { background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; }
    .quick-actions { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 0.5rem; }
    .fab { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 1.2rem; cursor: pointer; }
    /* Auth Modal */
    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: var(--bg-dark); margin: 15% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px; }
    .form-group { margin-bottom: 1rem; }
    .form-group input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; background: var(--text-dark); color: var(--text-dark); }
    .btn { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; width: 100%; margin: 0.25rem 0; }
    .btn-secondary { background: #6c757d; }
    .user-info { position: absolute; top: 1rem; right: 1rem; color: white; }
    .hidden { display: none; }
    @media (max-width: 768px) { .reader { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <div class="app">
    <!-- User Info (Phase 1.3: Profile Management) -->
    <div id="user-info" class="user-info hidden">
      <span id="user-display"></span> | <a href="#" onclick="logout()">Logout</a>
    </div>

    <!-- Primary Navigation (Always Visible) -->
    <nav class="nav">
      <a href="#home">Home</a>
      <a href="#read">Read</a>
      <a href="#discover">Discover</a>
      <a href="#community">Community</a>
      <a href="#profile">Profile</a>
    </nav>

    <!-- Auth Modal (Phase 1.3: Login/Register) -->
    <div id="auth-modal" class="modal">
      <div class="modal-content">
        <h2 id="modal-title">Login</h2>
        <form id="auth-form">
          <div class="form-group">
            <input type="email" id="email" placeholder="Email" required />
          </div>
          <div class="form-group">
            <input type="password" id="password" placeholder="Password" required />
          </div>
          <button type="submit" class="btn">Login</button>
          <button type="button" class="btn btn-secondary" onclick="toggleRegister()">Switch to Register</button>
        </form>
      </div>
    </div>

    <!-- Main Reader View (Protected Content) -->
    <section id="read" class="reader hidden" style="margin-top: 1rem;">
      <div class="verse-content">
        <h2 id="chapter-title">Genesis 1 (KJV)</h2>
        <div id="verses" class="verse-text">
          <!-- Bible text loaded from public domain KJV via dev10 structure -->
          <div class="verse"><span class="verse-num">1</span>In the beginning God created the heaven and the earth.</div>
          <div class="verse"><span class="verse-num">2</span>And the earth was without form, and void; and darkness <i>was</i> upon the face of the deep. And the Spirit of God moved upon the face of the waters.</div>
          <div class="verse highlight"><span class="verse-num">3</span>And God said, Let there be light: and there was light.</div>
          <!-- ... more verses ... -->
        </div>

        <!-- Book/Chapter Navigation (dev10 style) -->
        <div style="margin: 1.5rem 0; display: flex; justify-content: space-between;">
          <button onclick="prevChapter()">‚Üê Previous</button>
          <select id="book-select" onchange="changeBook()"></select>
          <select id="chapter-select" onchange="changeChapter()"></select>
          <button onclick="nextChapter()">Next ‚Üí</button>
        </div>
      </div>

      <!-- Notes & Highlights Panel (Phase 1.2 - User-Specific) -->
      <aside class="notes-panel">
        <h3>Notes & Highlights</h3>
        <div id="user-notes">
          <p><strong>Gen 1:3</strong> ‚Äì <em>First divine command. Light = revelation.</em> <small>(You, 2h ago)</small></p>
        </div>
        <textarea id="quick-note" placeholder="Add note to selected verse..." style="width:100%; margin-top:0.5rem;"></textarea>
        <button style="margin-top:0.5rem; background:var(--primary); color:white; border:none; padding:0.5rem 1rem; border-radius:4px;">Save Note</button>
      </aside>
    </section>

    <!-- Landing Page for New Users (Simplified Journey) -->
    <section id="landing" style="text-align: center; padding: 4rem 2rem;">
      <h1>Welcome to VerseCurator</h1>
      <p>Your journey through Scripture starts here. Discover, study, and connect.</p>
      <button class="btn" style="font-size:1.2rem; padding:1rem 2rem; margin:1rem;" onclick="showAuthModal()">Get Started</button>
      <p style="margin-top:2rem; opacity:0.7;">Quick Registration ‚Üí Verse of the Day ‚Üí Basic Reading ‚Üí Simple Notes</p>
    </section>
  </div>

  <!-- Quick Actions (Floating) - Protected -->
  <div class="quick-actions hidden">
    <div class="fab" onclick="toggleSearch()">üîç</div>
    <div class="fab" onclick="addQuickNote()">üìù</div>
    <div class="fab" onclick="toggleTheme()">üåô</div>
    <div class="fab" onclick="shareVerse()">üë•</div>
  </div>

  <!-- Scripts: Merge dev10 core logic + dev17 PWA + Phase 1.3 Auth -->
  <script type="module">
    // === Firebase Config (Replace with your project's config) ===
    const firebaseConfig = {
      apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX", // From Firebase Console
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Auth State Listener (Phase 1.3)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('user-display').textContent = user.email;
        document.getElementById('read').classList.remove('hidden');
        document.getElementById('quick-actions').classList.remove('hidden');
        document.getElementById('landing').style.display = 'none';
        loadUserPreferences(); // Stub for Phase 1.3 Preferences
      } else {
        // User is signed out
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('read').classList.add('hidden');
        document.getElementById('quick-actions').classList.add('hidden');
        document.getElementById('landing').style.display = 'block';
      }
    });

    // Auth Functions
    window.showAuthModal = function() {
      document.getElementById('auth-modal').style.display = 'block';
    };

    window.closeAuthModal = function() {
      document.getElementById('auth-modal').style.display = 'none';
    };

    window.toggleRegister = function() {
      const title = document.getElementById('modal-title');
      const submitBtn = document.querySelector('#auth-form button[type="submit"]');
      if (title.textContent === 'Login') {
        title.textContent = 'Register';
        submitBtn.textContent = 'Register';
      } else {
        title.textContent = 'Login';
        submitBtn.textContent = 'Login';
      }
    };

    document.getElementById('auth-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const title = document.getElementById('modal-title').textContent;
      try {
        if (title === 'Login') {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
        closeAuthModal();
      } catch (error) {
        alert(error.message);
      }
    });

    window.logout = async function() {
      await signOut(auth);
    };

    // Stub for User Preferences (Phase 1.3)
    function loadUserPreferences() {
      // Load theme, reading settings from localStorage or Firestore (future)
      console.log('Loading user preferences...');
    }

    // === dev10 Core Reading Engine (simplified) ===
    const books = [
      { name: "Genesis", chapters: 50 },
      { name: "Exodus", chapters: 40 },
      // ... full list (add all 66 books for MVP)
    ];

    function initBibleNav() {
      const bookSel = document.getElementById('book-select');
      books.forEach((b, i) => {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = b.name;
        bookSel.appendChild(opt);
      });
      updateChapterSelect();
    }

    function updateChapterSelect() {
      const bookIdx = document.getElementById('book-select').value;
      const chapSel = document.getElementById('chapter-select');
      chapSel.innerHTML = '';
      for (let i = 1; i <= books[bookIdx].chapters; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `Chapter ${i}`;
        chapSel.appendChild(opt);
      }
    }

    function changeBook() { updateChapterSelect(); loadChapter(); }
    function changeChapter() { loadChapter(); }
    function prevChapter() { /* logic to decrement chapter/book */ }
    function nextChapter() { /* logic to increment chapter/book */ }

    async function loadChapter() {
      const book = books[document.getElementById('book-select').value].name;
      const chap = document.getElementById('chapter-select').value;
      document.getElementById('chapter-title').textContent = `${book} ${chap} (KJV)`;

      // Simulate fetching from public domain KJV JSON (cached via dev17 PWA)
      // In production, use a real endpoint like Bible API or local cache
      try {
        const response = await fetch(`https://bible-api.com/${book.replace(/\s+/g, '') + chap}?translation=kjv`);
        const data = await response.json();
        const versesDiv = document.getElementById('verses');
        versesDiv.innerHTML = data.verses.map(v => 
          `<div class="verse"><span class="verse-num">${v.verse}</span>${v.text}</div>`
        ).join('');
      } catch (error) {
        // Fallback static content
        versesDiv.innerHTML = '<div class="verse"><span class="verse-num">1</span>Sample verse loaded.</div>';
      }
    }

    // === dev17 PWA Enhancements ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('https://mashifmj-prog.github.io/VerseCurator-dev17/sw.js')
          .then(reg => console.log('SW registered', reg))
          .catch(err => console.log('SW failed', err));
      });
    }

    // === Phase 1 Features: Highlights, Notes, Search, Theme ===
    let selectedVerse = null;
    document.addEventListener('click', e => {
      if (e.target.closest('.verse')) {
        const verse = e.target.closest('.verse');
        verse.classList.toggle('highlight');
        selectedVerse = verse.querySelector('.verse-num').textContent;
      }
    });

    function addQuickNote() {
      if (!selectedVerse) return alert("Select a verse first");
      const note = prompt("Your note:", "");
      if (note) {
        const notesDiv = document.getElementById('user-notes');
        notesDiv.innerHTML += `<p><strong>Gen 1:${selectedVerse}</strong> ‚Äì <em>${note}</em> <small>(You, now)</small></p>`;
        // In full impl: Save to Firestore under user.uid
      }
    }

    function toggleSearch() {
      const query = prompt("Search Scripture:");
      if (query) alert(`Searching: "${query}" (semantic search coming in Phase 2)`);
    }

    function toggleTheme() {
      document.body.classList.toggle('light');
      // Persist via localStorage + sync with user prefs
    }

    function shareVerse() {
      if (!selectedVerse) return alert("Select a verse");
      const text = document.querySelector(`.verse-num:contains(${selectedVerse})`).nextSibling.textContent;
      navigator.share?.({ title: "VerseCurator", text: `Gen 1:${selectedVerse} ‚Äì ${text}` });
    }

    // Init (only if auth ready)
    // initBibleNav(); // Moved to auth callback if needed
  </script>

  <!-- Offline Fallback (dev17) -->
  <noscript>
    <p style="text-align:center; padding:2rem; color:#aaa;">
      JavaScript is required for VerseCurator. Please enable it or use a modern browser.
    </p>
  </noscript>
</body>
</html>
